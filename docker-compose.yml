version: '3.8'

services:
  # ============================================
  # Android 빌드 환경
  # ============================================
  android-build:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/app
      - gradle-cache:/root/.gradle
    environment:
      - DB_ENCRYPTION_KEY=${DB_ENCRYPTION_KEY:-default_key}
    command: ./gradlew assembleDebug --no-daemon

  # ============================================
  # Release 빌드
  # ============================================
  android-release:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/app
      - gradle-cache:/root/.gradle
    environment:
      - DB_ENCRYPTION_KEY=${DB_ENCRYPTION_KEY}
      - KEYSTORE_PASSWORD=${KEYSTORE_PASSWORD}
      - KEY_ALIAS=${KEY_ALIAS}
      - KEY_PASSWORD=${KEY_PASSWORD}
    command: ./gradlew assembleRelease --no-daemon

  # ============================================
  # 테스트 실행
  # ============================================
  android-test:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/app
      - gradle-cache:/root/.gradle
    environment:
      - DB_ENCRYPTION_KEY=${DB_ENCRYPTION_KEY:-default_key}
    command: ./gradlew testDebugUnitTest --no-daemon

  # ============================================
  # Lint 검사
  # ============================================
  android-lint:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/app
      - gradle-cache:/root/.gradle
    environment:
      - DB_ENCRYPTION_KEY=${DB_ENCRYPTION_KEY:-default_key}
    command: ./gradlew lintDebug --no-daemon

volumes:
  gradle-cache:
